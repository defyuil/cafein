<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- SalesMapper.xml -->
<mapper namespace="com.cafein.mapper.SalesMapper">

	<!-- 수주 등록 -->
	<insert id="registPO" parameterType="com.cafein.domain.SalesVO">
		INSERT INTO purchaseorder (postate, pocode, pocnt, ordersdate, updatedate, ordersduedate, clientid, itemid, membercode)
		VALUES ( #{postate}, #{pocode}, #{pocnt}, #{ordersdate},#{updatedate}, #{ordersduedate}, #{clientid}, #{itemid}, #{membercode} )
	</insert>

	<!-- 수주 조회 -->
	<select id="getPOList" resultType="com.cafein.domain.SalesVO">
    SELECT po.poid, po.postate, po.pocnt, po.pocode, po.clientid, po.itemid, 
    cli.clientname, cli.clientcode, item.itemname, item.itemcode, 
    po.ordersdate, po.updatedate, po.ordersduedate, po.membercode
    FROM purchaseorder po
    JOIN item ON po.itemid = item.itemid
    JOIN client cli ON po.clientid = cli.clientid
    WHERE
    ORDER BY ordersdate desc, poid desc
</select>
	
	
	<!-- 품목 목록 (페이징) -->
	<select id="POListPage" resultType="com.cafein.domain.SalesVO">
		SELECT po.poid, po.postate, po.pocnt, po.pocode, po.clientid, po.itemid, 
		cli.clientname, cli.clientcode, item.itemname, item.itemcode, 
		po.ordersdate, po.updatedate, po.ordersduedate, po.membercode
		FROM purchaseorder po
		JOIN item ON po.itemid = item.itemid
		JOIN client cli ON po.clientid = cli.clientid
		<if test="option == 'clientcode'">
			where clientcode like concat('%', #{keyword}, '%')
		</if>
		<if test="option == 'itemcode'">
			where itemcode like concat('%', #{keyword}, '%')
		</if>
		ORDER BY ordersdate desc, poid desc
		limit #{cri.startPage}, #{cri.pageSize}
	</select>
	
	<!-- 납품서 조회 -->
	<select id="getReceiptList" resultType="com.cafein.domain.SalesVO">
	SELECT re.receiptid, cli.clientname, cli.businessnumber, cli.representative, cli.clientaddress, cli.clientphone, cli.clientfax, 
	ship.lotnumber, item.itemname, item.origin, item.itemweight, item.itemprice,
	rb.weight, re.ordersdate, po.ordersduedate, re.etc, re.sign
	FROM receipt re
	JOIN client cli ON re.clientid = cli.clientid
	JOIN ship ON re.shipid = ship.shipid
	JOIN item ON re.itemid = item.itemid
	JOIN roastedbean rb ON re.productid = rb.productid
	JOIN purchaseorder po ON re.poid = po.poid
	</select>
	
	
	<!-- 수주등록-납품처 -->
	<select id="cliList" resultType="com.cafein.domain.SalesVO">
		select * from client
	</select>
	
	<!-- 수주등록-품목 -->
	<select id="iList" resultType="com.cafein.domain.SalesVO">
		select * from item
		where itemcode like '%P%'
	</select>

	<!-- 수주코드 생성 -->
	<select id="getPOCount" resultType="int" parameterType="com.cafein.domain.SalesVO">
		select count(*) from purchaseorder
		<where>
		  <choose>
			<when test="postate == '대기'">
				and pocode like '%AL%';
			</when>
			<when test="postate == '진행'">
				and pocode like '%SK%';
			</when>
			<when test="postate == '완료'">
				and pocode like '%FJ%';
			</when>
			<otherwise>
				and pocode like '%GH%';
			</otherwise>
		  </choose>
		</where>
	</select>

	<!-- 수주수정 -->
	 <update id="updatePO">
	 	update purchaseorder set clientid=#{clientid}, itemid=#{itemid}, postate=#{postate}, pocnt=#{pocnt},
	 	ordersdate=#{ordersdate}, ordersduedate=#{ordersduedate}, updatedate=#{updatedate}, membercode=#{membercode}
	 	where poid=#{poid}
	 </update>
	 
	 <!-- 수주상태 취소 -->
	 <update id="cancelPOState">
	 	update purchaseorder set postate='취소' 
	 	where poid=#{poid}
	 </update>
	 
	 
</mapper>